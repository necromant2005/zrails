<?php
require_once '../library/Zrails/Db/Facade/Scale.php';

require_once './Zrails/Db/Facade/Scale/_files/tables/Users.php';

class Zrails_Db_Facade_ScaleTest extends PHPUnit_Framework_TestCase
{
    /**
     * Db horisontal scalable adapter
     * @var Core_Db_Adpater_Scale
     */
    protected $_db = null;

    protected $_users = null;

    protected function setUp()
    {
        $this->_db = new Zrails_Db_Facade_Scale(array(
            "tables" => array(
                "users" => array(
                    "scale"=> array(
                        "field"    => "id",
                        "strategy" => "Zrails_Db_Facade_Scale_Strategy_Crc32",
                    ),
                    "primary" => array(
                        "field"        =>"id",
                        "autogenerate" => true,
                        "provider"     => "Zrails_Db_Facade_Scale_Key_Provider_Random"
                     )
                ),
            ),
            "shards" => array(
                0 => Zend_Db::factory("Pdo_Mysql", array(
                         "host"     => "127.0.0.1",
                         "username" => "root",
                         "password" => "",
                         "dbname"   => "test0",
                    )
                ),
                1 => Zend_Db::factory("Pdo_Mysql", array(
                         "host"     => "127.0.0.1",
                         "username" => "root",
                         "password" => "",
                         "dbname"   => "test1",
                    )
                ),
        )));

        $this->_db->delete('users');
        $this->_users = new Users($this->_db);
    }

    public function testContShards()
    {
        $this->assertEquals($this->_db->getCountShards(), 2);
    }

    public function testGetScaleStrategy()
    {
        $strategy = $this->_db->getScaleStrategy('users');
        $this->assertEquals(get_class($strategy), 'Zrails_Db_Facade_Scale_Strategy_Crc32');
        $this->assertEquals($strategy->getField(), 'id');
    }

    public function testGetScaleStrategyNonExists()
    {
        try {
            $strategy = $this->_db->getScaleStrategy('users_non_exists');
        } catch (Exception $e) {}
        $this->assertEquals(get_class($e), 'Zend_Db_Adapter_Exception');
    }

    public function testStrategySelectShard()
    {
        $strategy = $this->_db->getScaleStrategy('users');
        $this->assertEquals($strategy->getShardName(1), 0);
        $this->assertEquals($strategy->getShardName(10000000000), 1);
        $this->assertEquals($strategy->getShardName('abc'), 0);
        $this->assertEquals($strategy->getShardName('sdfasdf'), 1);
    }

    public function testStrategyGetShard()
    {
        $strategy = $this->_db->getScaleStrategy('users');
        $shard  = $strategy->getShard(1);
        $config = $shard->getConfig();
        $this->assertEquals(get_class($shard), 'Zend_Db_Adapter_Pdo_Mysql');
        $this->assertEquals($config['dbname'], 'test0');
    }




    public function testInsertDbWithID()
    {
        $affectedRows = $this->_db->insert('users', array(
            "id"   => 5,
            "name" => "test-insert"
        ));
        $this->assertEquals($affectedRows, 1);

        $User = $this->_users->find(5)->current();
        $this->assertEquals($User->id, 5);
        $this->assertEquals($User->name, "test-insert");
    }

    public function testInsertModelWithID()
    {
        $this->_users->insert(array(
            "id"   => 5,
            "name" => "test-insert"
        ));

        $User = $this->_users->find(5)->current();
        $this->assertEquals($User->id, 5);
        $this->assertEquals($User->name, "test-insert");
    }

    public function testFetchOne()
    {
        foreach(array(1=>"peter", 2=>"kris", 4=>"jo") as $id=>$name) {
            $this->_db->insert('users', array('id'=>$id, 'name'=>$name));
            $User = $this->_users->find($id)->current();
            $this->assertEquals($User->id, $id);
            $this->assertEquals($User->name, $name);
        }
    }

    public function testFetchWithoutShard()
    {
        try {
            $this->_users->fetchAll("1");
        } catch (Zend_Db_Adapter_Exception $E) {}
        $this->assertEquals(get_class($E), "Zend_Db_Adapter_Exception");
    }


    public function testDelete()
    {
        $this->_users->insert(array(
            "id"   => 1,
            "name" => "test-insert"
        ));
        $User = $this->_users->find(1)->current();
        $User->delete();
        $UsersRows = $this->_users->find(1);
        $this->assertEquals(count($UsersRows), 0);
    }

    public function testUpdateWithoutMigrateObject()
    {
        $this->_users->insert(array(
            "id"   => 4,
            "name" => "jo"
        ));
        $User = $this->_users->find(4)->current();
        $User->name = "joseph";
        $User->save();
    }

    public function testUpdateWithMigrateObject()
    {
        $this->_users->insert(array(
            "id"   => 1,
            "name" => "jo"
        ));
        $User = $this->_users->find(1)->current();
        $User->id = 7;
        $User->save();

        $UsersRows = $this->_users->find(1);
        $this->assertEquals(count($UsersRows), 0);

        $User = $this->_users->find(7)->current();
        $this->assertEquals($User->id, 7);
    }

    public function testInsertWithAutogeneratedId()
    {
        $this->_users->insert(array(
            "name" => "test-insert"
        ));
        $id = $this->_db->lastInsertId();

        $User = $this->_users->find($id)->current();
        $this->assertEquals($User->id, $id);
        $this->assertEquals($User->name, "test-insert");
    }
}

